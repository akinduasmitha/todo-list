<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚úÖ ‡∑Ä‡∑ê‡∂© ‡∂Ω‡∑ê‡∂∫‡∑í‡∑É‡∑ä‡∂≠‡∑î‡∑Ä</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
       
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --bg-light: #f8f9fa;
            --bg-white: #ffffff;
            --bar-color: #ffc107;
            --old-task-bg: #e9ecef; 
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--bg-light);
            display: flex;
            justify-content: center;
        }

        .container {
            width: 100%;
            max-width: 800px;
            background: var(--bg-white);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 20px;
        }
        
        #currentDateHeader {
            text-align: center;
            font-size: 1.5em;
            color: var(--success-color);
            margin-bottom: 15px;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        
        .old-tasks-header {
            color: var(--secondary-color);
            border-bottom: 1px solid #ccc;
            padding-bottom: 5px;
            margin-top: 30px;
            font-size: 1.2em;
        }

       
        .input-area {
            display: flex;
            margin-bottom: 30px; 
            border: 2px solid var(--primary-color); 
            border-radius: 10px;
            overflow: hidden; 
            box-shadow: 0 5px 15px rgba(0, 123, 255, 0.2); 
            transition: box-shadow 0.3s;
        }

        .input-area:focus-within {
            box-shadow: 0 5px 20px rgba(0, 123, 255, 0.4); 
        }

        #taskInput {
            flex-grow: 1;
            
            padding: 15px 15px 15px 50px; 
            border: none; 
            font-size: 17px;
          
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%236c757d"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>') no-repeat 15px center;
            background-size: 20px 20px;
        }

        #taskInput:focus {
            outline: none; 
        }

        #addTaskButton {
            padding: 15px 25px; 
            background-color: var(--primary-color); 
            color: white;
            border: none;
            cursor: pointer;
            font-size: 17px;
            font-weight: bold;
            border-radius: 0; 
            transition: background-color 0.2s, transform 0.1s;
        }

        #addTaskButton:hover {
            background-color: #0056b3; 
            transform: translateY(-1px);
        }

        
        #todoList, #oldTodoList {
            list-style: none;
            padding: 0;
        }

        #todoList li, #oldTodoList li {
            padding: 15px;
            margin-bottom: 12px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            border-left: 5px solid #ffc107;
            background: #fff3cd;
            transition: all 0.3s ease-in-out;
        }

        #oldTodoList li {
            background: var(--old-task-bg);
            border-left: 5px solid var(--secondary-color);
            font-size: 0.9em;
        }
        
        #todoList li.completed, #oldTodoList li.completed {
            background: #d4edda;
            border-left: 5px solid var(--success-color);
        }
        
        .task-details {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }

        .task-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .task-info {
            display: flex;
            align-items: center;
            flex-wrap: wrap; 
        }

        .task-text {
            margin-left: 10px;
            font-size: 17px;
            word-break: break-word;
        }
        
        .task-added-date {
            margin-left: 10px;
            font-size: 0.8em;
            color: var(--secondary-color);
            white-space: nowrap; 
        }

        li.completed .task-text {
            text-decoration: line-through;
            color: var(--secondary-color);
        }

        .delete-button {
            background: var(--danger-color);
            color: white;
            border: none;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 4px;
            font-weight: bold;
            margin-left: 10px;
            opacity: 0.6;
            transition: opacity 0.2s;
        }

        .delete-button.can-delete {
            opacity: 1;
        }
        
        .progress-input-area {
            display: flex;
            align-items: center;
            margin-top: 10px;
            padding: 8px;
            background-color: #e9ecef;
            border-radius: 4px;
        }
        
        .progress-input-area input[type="number"] {
            width: 60px;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-right: 5px;
        }

        .progress-input-area button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }

        .circular-chart {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: grid;
            place-items: center;
            font-size: 9px;
            color: #333;
            font-weight: bold;
            margin-left: 10px;
            border: 2px solid #ccc; 
            background: #f0f0f0; 
        }
        
        .circular-chart span {
            z-index: 2;
        }
        
        #chartArea {
            margin-top: 40px;
            padding: 20px;
            background: var(--bg-white);
            border-radius: 12px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        #weeklyLineChart {
            max-height: 300px;
        }
        
        #weeklyReviewArea {
            margin-top: 30px;
            padding: 10px;
        }

        .review-header {
            color: var(--primary-color);
            margin-top: 20px;
            margin-bottom: 10px;
            font-size: 1.3em;
            text-align: center;
        }
        
        #weeklyReview {
            background: #e6f7ff; 
            padding: 15px;
            border-radius: 8px;
            border-left: 5px solid var(--primary-color);
            line-height: 1.6;
            font-size: 1.1em;
            white-space: pre-wrap; 
            font-weight: 500;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>üóìÔ∏è ‡∂ö‡∑è‡∂ª‡∑ä‡∂∫ ‡∂Ω‡∑ê‡∂∫‡∑í‡∑É‡∑ä‡∂≠‡∑î‡∑Ä</h1>
        <p>Created by **Akidu Asmitha**</p>
        
        <h2 id="currentDateHeader"></h2>
        
        <div class="input-area">
            <input type="text" id="taskInput" placeholder="‡∂±‡∑Ä ‡∂ö‡∑è‡∂ª‡∑ä‡∂∫‡∂∫ ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±">
            <button id="addTaskButton">add task</button>
        </div>

        <ul id="todoList">
            </ul>
        
        <hr>

        <div id="chartArea">
            <h2>üìä ‡∑É‡∂≠‡∑í‡∂¥‡∂≠‡∑è ‡∑É‡∑è‡∂∏‡∑è‡∂±‡∑ä‚Äç‡∂∫ ‡∂¥‡∑ä‚Äç‡∂ª‡∂ú‡∂≠‡∑í‡∂∫ </h2>
            <canvas id="weeklyLineChart"></canvas>
        </div>
        
        <div id="weeklyReviewArea">
            <h3 class="review-header">‚ú® ‡∑É‡∂≠‡∑í‡∂¥‡∂≠‡∑è ‡∑É‡∂∏‡∑è‡∂Ω‡∑ù‡∂†‡∂±‡∂∫ ‡∑É‡∑Ñ ‡∂Ø‡∑í‡∂ª‡∑í‡∂ú‡∑ê‡∂±‡∑ä‡∑Ä‡∑ì‡∂∏</h3>
            <p id="weeklyReview" class="review-content">‡∂Ø‡∂≠‡∑ä‡∂≠ ‡∂Ω‡∂∂‡∑è‡∂ú‡∂≠‡∑ä ‡∂¥‡∑É‡∑î ‡∑É‡∂∏‡∑è‡∂Ω‡∑ù‡∂†‡∂±‡∂∫ ‡∂Ø‡∑í‡∑É‡∑ä ‡∑Ä‡∂±‡∑î ‡∂á‡∂≠.</p>
        </div>

        <hr>

        <h3 class="old-tasks-header">üì¶ ‡∂¥‡∑ê‡∂ª‡∂´‡∑í ‡∂ö‡∑è‡∂ª‡∑ä‡∂∫‡∂∫‡∂±‡∑ä</h3>
        <ul id="oldTodoList">
            </ul>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- ‡∂ú‡∑ù‡∂Ω‡∑ì‡∂∫ ‡∑Ä‡∑í‡∂†‡∂Ω‡∑ä‚Äç‡∂∫‡∂∫‡∂±‡∑ä ‡∑É‡∑Ñ ‡∂≠‡∑ú‡∂ú‡∂∫ (Throttling) ---
            const taskInput = document.getElementById('taskInput');
            const addTaskButton = document.getElementById('addTaskButton');
            const todoList = document.getElementById('todoList');
            const oldTodoList = document.getElementById('oldTodoList');
            const weeklyChartCanvas = document.getElementById('weeklyLineChart');
            const currentDateHeader = document.getElementById('currentDateHeader');
            
            // ‡∂ö‡∑è‡∂ª‡∑ä‡∂∫ ‡∑É‡∑è‡∂∞‡∂±‡∂∫ ‡∑Ä‡∑ê‡∂©‡∑í ‡∂Ø‡∑í‡∂∫‡∑î‡∂´‡∑î ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏ ‡∑É‡∂≥‡∑Ñ‡∑è ‡∂ú‡∑ù‡∂Ω‡∑ì‡∂∫ ‡∂Ø‡∂≠‡∑ä‡∂≠ Array
            let TASKS_DATA_ARRAY = []; 
            let weeklyLineChart = null;
            let saveTimeout = null; // Throttling ‡∑É‡∂≥‡∑Ñ‡∑è
            
            const TASK_STORAGE_KEY = 'final_todo_v5_tasks'; 
            const CHART_STORAGE_KEY = 'final_todo_v5_chartData'; 
            const THROTTLE_TIME = 200; // Local Storage ‡∑Ä‡∑ô‡∂≠ ‡∂Ω‡∑í‡∑Ä‡∑ì‡∂∏ 200ms ‡∂ß ‡∑Ä‡∂ª‡∂ö‡∑ä ‡∂¥‡∂∏‡∂´‡∂ö‡∑ä ‡∑É‡∑í‡∂Ø‡∑î ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∂ß

            const daysOfWeekLabels = ['‡∂â‡∂ª‡∑í‡∂Ø‡∑è', '‡∑É‡∂≥‡∑î‡∂Ø‡∑è', '‡∂Ö‡∂ü‡∑Ñ‡∂ª‡∑î‡∑Ä‡∑è‡∂Ø‡∑è', '‡∂∂‡∂Ø‡∑è‡∂Ø‡∑è', '‡∂∂‡∑ä‚Äç‡∂ª‡∑Ñ‡∑É‡∑ä‡∂¥‡∂≠‡∑í‡∂±‡∑ä‡∂Ø‡∑è', '‡∑É‡∑í‡∂ö‡∑î‡∂ª‡∑è‡∂Ø‡∑è', '‡∑É‡∑ô‡∂±‡∑É‡∑î‡∂ª‡∑è‡∂Ø‡∑è'];
            
            // --- Helper Functions (Date, Chart Update) ---

            function getTodayDateString() {
                const today = new Date();
                const year = today.getFullYear();
                const month = (today.getMonth() + 1).toString().padStart(2, '0');
                const day = today.getDate().toString().padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            
            function getFormattedTodayDate() {
                const today = new Date();
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                return today.toLocaleDateString('si-LK', options); 
            }
            
            currentDateHeader.textContent = `‡∂Ö‡∂Ø ‡∂Ø‡∑í‡∂±: ${getFormattedTodayDate()}`;
            
            function updateCircularChart(element, percentage) {
                const color = percentage === 100 ? getComputedStyle(document.documentElement).getPropertyValue('--success-color').trim() : getComputedStyle(document.documentElement).getPropertyValue('--bar-color').trim();
                element.style.background = `conic-gradient(${color} ${percentage}%, #ccc ${percentage}%)`;
                element.querySelector('span').textContent = `${percentage}%`;
            }

            // --- 1. Load Tasks (‡∂ú‡∑ù‡∂Ω‡∑ì‡∂∫ Array ‡∂∑‡∑è‡∑Ä‡∑í‡∂≠‡∂∫‡∑ô‡∂±‡∑ä) ---
            function loadTasks() {
                todoList.innerHTML = ''; 
                oldTodoList.innerHTML = ''; 
                TASKS_DATA_ARRAY = []; 

                const todayDate = getTodayDateString();
                try {
                    const tasks = JSON.parse(localStorage.getItem(TASK_STORAGE_KEY)) || [];
                    
                    tasks.forEach(task => {
                        TASKS_DATA_ARRAY.push(task); 
                        if (task.addedDate === todayDate) {
                            createTaskElement(task, todoList, false); 
                        } else {
                            createTaskElement(task, oldTodoList, true); 
                        }
                    });

                } catch (e) {
                    console.error("Local Storage ‡∑Ä‡∑ô‡∂≠‡∑í‡∂±‡∑ä Tasks ‡∂¥‡∑ê‡∂ß‡∑Ä‡∑ì‡∂∏‡∑ö ‡∂Ø‡∑ù‡∑Ç‡∂∫:", e);
                    localStorage.removeItem(TASK_STORAGE_KEY);
                }
            }
            
            // --- 2. Save Tasks (Throttled Function) ---
            function saveTasks() {
                if (saveTimeout) {
                    clearTimeout(saveTimeout);
                }
                
                saveTimeout = setTimeout(() => {
                    localStorage.setItem(TASK_STORAGE_KEY, JSON.stringify(TASKS_DATA_ARRAY));
                    saveTimeout = null;
                }, THROTTLE_TIME);
            }

            // --- 3. Create Task Element ---
            function createTaskElement(task, parentList, isOldTask) {
                const listItem = document.createElement('li');
                listItem.dataset.taskId = task.id; 

                if (task.completed) {
                    listItem.classList.add('completed');
                }

                const taskDetails = document.createElement('div');
                taskDetails.className = 'task-details';

                const taskHeader = document.createElement('div');
                taskHeader.className = 'task-header';

                const taskInfo = document.createElement('div');
                taskInfo.className = 'task-info';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = task.completed;
                taskInfo.appendChild(checkbox);

                const taskSpan = document.createElement('span');
                taskSpan.className = 'task-text';
                taskSpan.textContent = task.text;
                taskInfo.appendChild(taskSpan);
                
                if (isOldTask) {
                    const dateSpan = document.createElement('span');
                    dateSpan.className = 'task-added-date';
                    dateSpan.textContent = `(‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∑Ö‡∑ö: ${task.addedDate})`;
                    taskInfo.appendChild(dateSpan);
                }

                taskHeader.appendChild(taskInfo);

                const deleteButton = document.createElement('button');
                deleteButton.className = 'delete-button';
                deleteButton.innerHTML = '‚úñ ‡∂∏‡∂ö‡∂±‡∑ä‡∂±';

                if (task.addedDate === getTodayDateString()) {
                    deleteButton.classList.add('can-delete');
                    deleteButton.onclick = function() {
                        TASKS_DATA_ARRAY = TASKS_DATA_ARRAY.filter(t => t.id !== task.id);
                        parentList.removeChild(listItem); 
                        saveTasks(); 
                        updateProgressChart(); 
                    };
                } else {
                    deleteButton.disabled = true;
                    deleteButton.title = `‡∂∏‡∑ô‡∂∫ ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∑Ö ‡∂Ø‡∑í‡∂±‡∂∫ ${task.addedDate}. ‡∂∏‡∂ö‡∑è ‡∂Ø‡∑ê‡∂∏‡∑í‡∂∫ ‡∑Ñ‡∑ê‡∂ö‡∑ä‡∂ö‡∑ö ‡∂Ö‡∂Ø ‡∂Ø‡∑í‡∂±‡∂ß ‡∂¥‡∂∏‡∂´‡∑í.`;
                }
                
                taskHeader.appendChild(deleteButton);
                taskDetails.appendChild(taskHeader);
                
                // --- Percentage Input Area / Circular Chart ---
                const progressInputArea = document.createElement('div');
                progressInputArea.className = 'progress-input-area';
                
                const progressText = document.createElement('span');
                progressText.textContent = '‡∂¥‡∑ä‚Äç‡∂ª‡∂ú‡∂≠‡∑í‡∂∫ (%):';
                progressInputArea.appendChild(progressText);

                const progressInput = document.createElement('input');
                progressInput.type = 'number';
                progressInput.min = 0;
                progressInput.max = 100;
                progressInput.value = task.percentage || 0;
                progressInput.disabled = !task.completed; 
                progressInputArea.appendChild(progressInput);

                const saveProgressButton = document.createElement('button');
                saveProgressButton.textContent = '‡∂ú‡∂∂‡∂©‡∑è ‡∂ö‡∂ª‡∂±‡∑ä‡∂±';
                saveProgressButton.disabled = !task.completed;
                
                const circularChart = document.createElement('div');
                circularChart.className = 'circular-chart';
                const chartText = document.createElement('span');
                circularChart.appendChild(chartText);

                updateCircularChart(circularChart, task.percentage || 0);

                progressInputArea.appendChild(saveProgressButton);
                progressInputArea.appendChild(circularChart);
                taskDetails.appendChild(progressInputArea);

                listItem.appendChild(taskDetails);
                parentList.appendChild(listItem);


                // --- Event Listeners (‡∂¥‡∑ä‚Äç‡∂ª‡∑Å‡∑É‡∑ä‡∂≠‡∂ö‡∂ª‡∂´‡∂∫ ‡∂ö‡∂ª‡∂± ‡∂Ω‡∂Ø‡∑ì) ---
                
                const taskIndex = TASKS_DATA_ARRAY.findIndex(t => t.id === task.id);

                // 3.1. Checkbox Listener
                checkbox.addEventListener('change', function() {
                    const isChecked = this.checked;
                    listItem.classList.toggle('completed', isChecked);
                    
                    progressInput.disabled = !isChecked;
                    saveProgressButton.disabled = !isChecked;
                    
                    if (taskIndex !== -1) {
                        TASKS_DATA_ARRAY[taskIndex].completed = isChecked;
                        if (!isChecked) {
                            TASKS_DATA_ARRAY[taskIndex].percentage = 0;
                            progressInput.value = 0;
                        } 
                        updateCircularChart(circularChart, TASKS_DATA_ARRAY[taskIndex].percentage);
                        saveTasks(); 
                        updateProgressChart(); 
                    }
                });

                // 3.2. Progress Save Listener
                saveProgressButton.addEventListener('click', function() {
                    let percentage = parseInt(progressInput.value) || 0;
                    if (percentage < 0) percentage = 0;
                    if (percentage > 100) percentage = 100;

                    if (taskIndex !== -1) {
                        TASKS_DATA_ARRAY[taskIndex].percentage = percentage;
                        updateCircularChart(circularChart, percentage);
                        saveTasks(); 
                        updateProgressChart(); 
                    }
                });

                // 3.3. Progress Input Keypress
                 progressInput.addEventListener('keypress', function(event) {
                    if (event.key === 'Enter') {
                        saveProgressButton.click();
                    }
                });
            }

            // --- 4. Add Task ---
            function addTask() {
                const taskText = taskInput.value.trim();

                if (taskText !== "") {
                    const newTask = {
                        id: Date.now(), 
                        text: taskText,
                        completed: false,
                        percentage: 0,
                        addedDate: getTodayDateString() 
                    };

                    TASKS_DATA_ARRAY.push(newTask); 
                    createTaskElement(newTask, todoList, false); 
                    saveTasks(); 
                    taskInput.value = ''; 
                    taskInput.focus();
                }
            }

            // --- 5. Chart Functions and Review Generation ---
            
            function generateReview(data) {
                const reviewElement = document.getElementById('weeklyReview');
                const totalPercentage = data.reduce((sum, value) => sum + value, 0);
                const average = Math.round(totalPercentage / 7); 

                let message = "";
                let emoji = "";

                if (average >= 90) {
                    emoji = "ü§© ‡∑Ä‡∑í‡∑Å‡∑í‡∑Ç‡∑ä‡∂ß‡∂∫‡∑í!";
                    message = `**‡∑É‡∑î‡∂¥‡∑í‡∂ª‡∑í ‡∑Ä‡∑ê‡∂©‡∂ö‡∑ä!** ‡∂∏‡∑ö ‡∑É‡∂≠‡∑í‡∂∫‡∑ö ‡∂î‡∂∂‡∑ö ‡∑É‡∑è‡∂∏‡∑è‡∂±‡∑ä‚Äç‡∂∫ ‡∂¥‡∑ä‚Äç‡∂ª‡∂ú‡∂≠‡∑í‡∂∫ **${average}%** ‡∂ö‡∑í. ‡∂î‡∂∂ ‡∂ö‡∑è‡∂ª‡∑ä‡∂∫‡∂∫‡∂±‡∑ä ‡∂±‡∑í‡∂∫‡∂∏‡∑í‡∂≠ ‡∑Ä‡∑ö‡∂Ω‡∑è‡∑Ä‡∂ß ‡∂Ö‡∑Ä‡∑É‡∂±‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∑ö‡∂Ø‡∑ì ‡∑Ä‡∑í‡∑Å‡∑í‡∑Ç‡∑ä‡∂ß ‡∑É‡∑ä‡∂Æ‡∑è‡∑Ä‡∂ª‡∂≠‡∑ä‡∑Ä‡∂∫‡∂ö‡∑ä ‡∂¥‡∑ô‡∂±‡∑ä‡∑Ä‡∑è ‡∂á‡∂≠. ‡∂∏‡∑ô‡∂∫ ‡∂â‡∂≠‡∑è ‡∂â‡∑Ñ‡∑Ö ‡∑É‡∑è‡∂ª‡∑ä‡∂Æ‡∂ö‡∂≠‡∑ä‡∑Ä‡∂∫‡∂ö‡∑ä! ‡∂â‡∂Ø‡∑í‡∂ª‡∑í‡∂∫‡∂ß‡∂≠‡∑ä ‡∂∏‡∑ö ‡∂Ö‡∂∫‡∑î‡∂ª‡∑í‡∂±‡∑ä‡∂∏ ‡∂∫‡∂±‡∑ä‡∂±, ‡∂Ø‡∑Ä‡∑É‡∑í‡∂±‡∑ä ‡∂Ø‡∑Ä‡∑É ‡∂î‡∂∂ ‡∂Ø‡∑í‡∂∫‡∑î‡∂´‡∑î ‡∑Ä‡∑ô‡∂±‡∑Ä‡∑è!`;
                } else if (average >= 70) {
                    emoji = "üëç ‡∂â‡∂≠‡∑è ‡∑Ñ‡∑ú‡∂≥‡∂∫‡∑í!";
                    message = `**‡∂â‡∂≠‡∑è ‡∑Ñ‡∑ú‡∂≥‡∂∫‡∑í!** ‡∂î‡∂∂‡∑ö ‡∑É‡∑è‡∂∏‡∑è‡∂±‡∑ä‚Äç‡∂∫ ‡∂¥‡∑ä‚Äç‡∂ª‡∂ú‡∂≠‡∑í‡∂∫ **${average}%** ‡∂ö‡∑í. ‡∂î‡∂∂ ‡∂Ö‡∂õ‡∂´‡∑ä‡∂©‡∑Ä ‡∑Ñ‡∑ú‡∂≥ ‡∂ã‡∂≠‡∑ä‡∑É‡∑è‡∑Ñ‡∂∫‡∂ö‡∑ä ‡∂Ø‡∂ª‡∂± ‡∂∂‡∑Ä ‡∂¥‡∑ê‡∑Ñ‡∑ê‡∂Ø‡∑í‡∂Ω‡∑í‡∂∫‡∑í. ‡∑É‡∑ä‡∂Æ‡∑è‡∑Ä‡∂ª‡∑Ä ‡∑Ä‡∑ê‡∂© ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏ ‡∑Ä‡∑í‡∑Å‡∑è‡∂Ω ‡∂Ø‡∑í‡∂∫‡∑î‡∂´‡∑î‡∑Ä‡∂ö‡∑ä ‡∂¥‡∑ô‡∂±‡∑ä‡∂±‡∑î‡∂∏‡∑ä ‡∂ö‡∂ª‡∂∫‡∑í. ‡∂≠‡∑Ä‡∂≠‡∑ä ‡∑É‡∑î‡∑Ö‡∑î ‡∂ã‡∂≠‡∑ä‡∑É‡∑è‡∑Ñ‡∂∫‡∂ö‡∑í‡∂±‡∑ä ‡∂ä‡∑Ö‡∂ü ‡∂∏‡∂ß‡∑ä‡∂ß‡∂∏‡∂ß ‡∂∫‡∑è ‡∑Ñ‡∑ê‡∂ö‡∑í‡∂∫‡∑í! ‡∑Ä‡∑í‡∑Å‡∑è‡∂Ω ‡∂ö‡∑è‡∂ª‡∑ä‡∂∫‡∂∫‡∂±‡∑ä ‡∂ö‡∑î‡∂©‡∑è ‡∂ö‡∑ú‡∂ß‡∑É‡∑ä‡∑Ä‡∂Ω‡∂ß ‡∂ö‡∂©‡∑è ‡∂Ø‡∑í‡∂±‡∂ö‡∂ß ‡∂ë‡∂ö‡∂ö‡∑ä ‡∑Ñ‡∑ù ‡∂Ø‡∑ô‡∂ö‡∂ö‡∑ä ‡∂±‡∑í‡∂∏ ‡∂ö‡∂ª‡∂±‡∑ä‡∂±.`;
                } else if (average >= 50) {
                    emoji = "üß† ‡∑Ñ‡∑ú‡∂≥ ‡∂Ü‡∂ª‡∂∏‡∑ä‡∂∑‡∂∫‡∂ö‡∑ä!";
                    message = `**‡∑Ñ‡∑ú‡∂≥ ‡∂Ü‡∂ª‡∂∏‡∑ä‡∂∑‡∂∫‡∂ö‡∑ä!** ‡∑É‡∂≠‡∑í‡∂∫‡∑ö ‡∑É‡∑è‡∂∏‡∑è‡∂±‡∑ä‚Äç‡∂∫ ‡∂¥‡∑ä‚Äç‡∂ª‡∂ú‡∂≠‡∑í‡∂∫ **${average}%** ‡∂ö‡∑í. ‡∂î‡∂∂ ‡∑Ä‡∑ê‡∂© ‡∂ö‡∂ª‡∂±‡∑Ä‡∑è, ‡∂í‡∂≠‡∑ä ‡∂≠‡∑Ä ‡∂ß‡∑í‡∂ö‡∂ö‡∑ä ‡∂Ö‡∑Ä‡∂∞‡∑è‡∂±‡∂∫ ‡∂Ø‡∑ô‡∂±‡∑ä‡∂± ‡∂¥‡∑î‡∑Ö‡∑î‡∑Ä‡∂±‡∑ä. ‡∂î‡∂∂‡∑ö ‡∑É‡∑ê‡∂Ω‡∑É‡∑î‡∂∏‡∑ä‡∂ö‡∂ª‡∂´‡∂∫ (Planning) ‡∂Ø‡∑í‡∂∫‡∑î‡∂´‡∑î ‡∂ö‡∂ª‡∂±‡∑ä‡∂± ‡∂∂‡∂Ω‡∂±‡∑ä‡∂±. ‡∑É‡∑ë‡∂∏ ‡∂Ø‡∑í‡∂±‡∂ö‡∂∏ ‡∂Ö‡∑Ä‡∂∏ ‡∑Ä‡∑Å‡∂∫‡∑ô‡∂±‡∑ä ‡∂ë‡∂ö‡∑ä ‡∂ö‡∑è‡∂ª‡∑ä‡∂∫‡∂∫‡∂ö‡∑ä ‡∑Ñ‡∑ù ‡∑É‡∂∏‡∑ä‡∂¥‡∑ñ‡∂ª‡∑ä‡∂´ ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∂ß ‡∂â‡∂Ω‡∂ö‡∑ä‡∂ö‡∂∫‡∂ö‡∑ä ‡∂≠‡∂∂‡∑è ‡∂ú‡∂±‡∑ä‡∂±. ‡∂∏‡∂≠‡∂ö ‡∂≠‡∂∂‡∑è ‡∂ú‡∂±‡∑ä‡∂±, ‡∂Ö‡∂õ‡∂´‡∑ä‡∂©‡∂≠‡∑è‡∑Ä ‡∂¢‡∂∫‡∂ú‡∑ä‚Äç‡∂ª‡∑Ñ‡∂´‡∂∫‡∑ö ‡∂ª‡∑Ñ‡∑É‡∂∫‡∑í!`;
                } else if (average > 0) {
                    emoji = "ü§î ‡∑Ä‡∑ê‡∂©‡∑í ‡∂Ø‡∑í‡∂∫‡∑î‡∂´‡∑î ‡∂ö‡∑Ö ‡∂∫‡∑î‡∂≠‡∑î‡∂∫‡∑í.";
                    message = `**‡∑Ä‡∑ê‡∂©‡∑í ‡∂Ø‡∑í‡∂∫‡∑î‡∂´‡∑î ‡∂ö‡∑Ö ‡∂∫‡∑î‡∂≠‡∑î‡∂∫‡∑í.** ‡∂∏‡∑ö ‡∑É‡∂≠‡∑í‡∂∫‡∑ö ‡∂î‡∂∂‡∑ö ‡∑É‡∑è‡∂∏‡∑è‡∂±‡∑ä‚Äç‡∂∫ ‡∂¥‡∑ä‚Äç‡∂ª‡∂ú‡∂≠‡∑í‡∂∫ **${average}%** ‡∂Ø‡∂ö‡∑ä‡∑Ä‡∑è ‡∂Ö‡∂©‡∑î ‡∑Ä‡∑ì ‡∂≠‡∑í‡∂∂‡∑ô‡∂±‡∑Ä‡∑è. ‡∑É‡∂∏‡∑Ñ‡∂ª‡∑Ä‡∑í‡∂ß ‡∂ö‡∑è‡∂ª‡∑ä‡∂∫‡∂∫‡∂±‡∑ä ‡∑Ä‡∑ê‡∂©‡∑í‡∂∫‡∑í, ‡∂±‡∑ê‡∂≠‡∑ä‡∂±‡∂∏‡∑ä ‡∑Ä‡∑ê‡∂© ‡∂¥‡∂ß‡∂±‡∑ä ‡∂ú‡∂±‡∑ä‡∂± ‡∂Ö‡∂∏‡∑è‡∂ª‡∑î ‡∂á‡∂≠‡∑í. ‡∂î‡∂∂‡∑ö ‡∂Ø‡∑Ä‡∑É‡∂ß ‡∂ö‡∑î‡∂©‡∑è, ‡∂ö‡∑Ö‡∂∏‡∂±‡∑è‡∂ö‡∂ª‡∂´‡∂∫ ‡∂ö‡∑Ö ‡∑Ñ‡∑ê‡∂ö‡∑í ‡∂ö‡∑è‡∂ª‡∑ä‡∂∫‡∂∫‡∂±‡∑ä ‡∂ë‡∂ö‡∂≠‡∑î ‡∂ö‡∂ª‡∂±‡∑ä‡∂±. ‡∂Ö‡∂Ø‡∂∏ ‡∂¥‡∂ß‡∂±‡∑ä ‡∂ú‡∂±‡∑ä‡∂±! "‡∂∏‡∂∏ ‡∂∏‡∑ö ‡∑É‡∂≠‡∑í‡∂∫ ‡∑Ñ‡∑ú‡∂≥‡∂ß ‡∂ö‡∑Ö‡∑è" ‡∂ö‡∑í‡∂∫‡∂± ‡∑Ñ‡∑ê‡∂ü‡∑ì‡∂∏ ‡∂á‡∂≠‡∑í ‡∂ö‡∂ª‡∂ú‡∂±‡∑ä‡∂± ‡∂ã‡∂≠‡∑ä‡∑É‡∑è‡∑Ñ ‡∂ö‡∂ª‡∂±‡∑ä‡∂±.`;
                } else {
                    emoji = "üåü ‡∂Ö‡∂¥‡∑í ‡∂¥‡∂ß‡∂±‡∑ä ‡∂ú‡∂∏‡∑î!";
                    message = `**‡∂Ö‡∂¥‡∑í ‡∂¥‡∂ß‡∂±‡∑ä ‡∂ú‡∂∏‡∑î!** ‡∂∏‡∑ö ‡∑É‡∂≠‡∑í‡∂∫‡∑ö ‡∂ö‡∑í‡∑É‡∑í‡∂Ø‡∑î ‡∂¥‡∑ä‚Äç‡∂ª‡∂ú‡∂≠‡∑í‡∂∫‡∂ö‡∑ä ‡∑É‡∂ß‡∑Ñ‡∂±‡∑ä ‡∑Ä‡∑ì ‡∂±‡∑ê‡∑Ñ‡∑ê. ‡∂ö‡∑è‡∂ª‡∑ä‡∂∫‡∂∫‡∂±‡∑ä ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª, ‡∂í‡∑Ä‡∑è ‡∂Ö‡∑Ä‡∑É‡∂±‡∑ä ‡∂ö‡∂ª ‡∂¥‡∑ä‚Äç‡∂ª‡∂ú‡∂≠‡∑í‡∂∫ ‡∑É‡∂ß‡∑Ñ‡∂±‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±. ‡∑É‡∑ë‡∂∏ ‡∑Ä‡∑í‡∑Å‡∑è‡∂Ω ‡∂ú‡∂∏‡∂±‡∂ö‡∑ä‡∂∏ ‡∂Ü‡∂ª‡∂∏‡∑ä‡∂∑ ‡∑Ä‡∂±‡∑ä‡∂±‡∑ö ‡∂ö‡∑î‡∂©‡∑è ‡∂¥‡∑Ö‡∂∏‡∑î ‡∂¥‡∑í‡∂∫‡∑Ä‡∂ª‡∂ö‡∑í‡∂±‡∑í. ‡∂Ö‡∂Ø‡∂∏ ‡∂î‡∂∂‡∑ö ‡∂¥‡∑Ö‡∂∏‡∑î ‡∂ö‡∑è‡∂ª‡∑ä‡∂∫‡∂∫ ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª ‡∂Ö‡∑Ä‡∑É‡∂±‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±. ‡∂î‡∂∂‡∂ß ‡∂¥‡∑î‡∑Ö‡∑î‡∑Ä‡∂±‡∑ä!`;
                }

                reviewElement.innerHTML = `${message}`;
                reviewElement.previousElementSibling.textContent = `${emoji} ‡∑É‡∂≠‡∑í‡∂¥‡∂≠‡∑è ‡∑É‡∂∏‡∑è‡∂Ω‡∑ù‡∂†‡∂±‡∂∫ ‡∑É‡∑Ñ ‡∂Ø‡∑í‡∂ª‡∑í‡∂ú‡∑ê‡∂±‡∑ä‡∑Ä‡∑ì‡∂∏`; 
            }

            function loadChartData() {
                const defaultData = [0, 0, 0, 0, 0, 0, 0]; 
                try {
                    const storedData = JSON.parse(localStorage.getItem(CHART_STORAGE_KEY)) || {};
                    let chartDataArray = [...defaultData];
                    
                    for (let i = 0; i < 7; i++) {
                        if (storedData[i] !== undefined) {
                            chartDataArray[i] = storedData[i];
                        }
                    }
                    renderChart(chartDataArray);
                    generateReview(chartDataArray); 
                    return storedData; 
                } catch (e) {
                    console.error("Chart data loading error:", e);
                    localStorage.removeItem(CHART_STORAGE_KEY);
                    renderChart(defaultData);
                    generateReview(defaultData);
                    return {};
                }
            }

            function saveChartData(chartDataObject) {
                localStorage.setItem(CHART_STORAGE_KEY, JSON.stringify(chartDataObject));
            }

            function updateProgressChart() {
                const today = new Date();
                const dayIndex = today.getDay(); 

                let chartDataObj = loadChartData(); 
                const completedTasks = TASKS_DATA_ARRAY.filter(t => t.completed); 
                
                let totalPercentage = 0;
                let taskCount = completedTasks.length;

                completedTasks.forEach(t => { totalPercentage += t.percentage; });

                const averagePercentage = taskCount > 0 ? Math.round(totalPercentage / taskCount) : 0;
                
                chartDataObj[dayIndex] = averagePercentage;
                
                saveChartData(chartDataObj); 
                
                let chartDataArray = new Array(7).fill(0);
                for (let i = 0; i < 7; i++) {
                     if (chartDataObj[i] !== undefined) {
                        chartDataArray[i] = chartDataObj[i];
                    }
                }
                renderChart(chartDataArray); 
                generateReview(chartDataArray); 
            }
            
            function renderChart(data) {
                const primaryColor = getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim();
                
                if (weeklyLineChart) {
                    weeklyLineChart.data.datasets[0].data = data;
                    weeklyLineChart.update();
                    return;
                }

                weeklyLineChart = new Chart(weeklyChartCanvas, {
                    type: 'line',
                    data: {
                        labels: daysOfWeekLabels,
                        datasets: [{
                            label: '‡∂Ø‡∑õ‡∂±‡∑í‡∂ö ‡∑É‡∑è‡∂∏‡∑è‡∂±‡∑ä‚Äç‡∂∫ ‡∂¥‡∑ä‚Äç‡∂ª‡∂ú‡∂≠‡∑í‡∂∫ (%)',
                            data: data,
                            borderColor: primaryColor,
                            backgroundColor: primaryColor + '10', 
                            fill: true,
                            tension: 0.4, 
                            pointBackgroundColor: primaryColor,
                            pointRadius: 5,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                         animation: {
                            duration: 500, // Animation ‡∂ö‡∑è‡∂Ω‡∂∫ ‡∂Ö‡∂©‡∑î ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                title: {
                                    display: true,
                                    text: '‡∂¥‡∑ä‚Äç‡∂ª‡∂ú‡∂≠‡∑í‡∂∫ (%)'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                            },
                            title: {
                                display: false
                            }
                        }
                    }
                });
            }
            
            // --- 6. Event Handlers ---
            addTaskButton.addEventListener('click', addTask);
            taskInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    addTask();
                }
            });

            // --- Initial Load ---
            loadTasks();
            loadChartData(); 
            updateProgressChart(); 
        });
    </script>
</body>
</html>
